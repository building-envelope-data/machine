---
- name: Setup Machine
  hosts: localhost
  connection: local

  handlers:
    - name: Restart Docker
      become: true
      ansible.builtin.service:
        name: docker
        state: restarted
      tags: skip_in_development

    - name: Reload Vector
      become: true
      ansible.builtin.service:
        name: vector
        state: reloaded
      tags: skip_in_development

    - name: Reload Monit
      become: true
      ansible.builtin.service:
        name: monit
        state: reloaded
      tags: skip_in_development

    - name: Send test email as root
      become: true
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          echo "Test email as root user from new/updated MSTMP at" `hostname` \
            | mail -s "Test SMTP `hostname`" root
        executable: /bin/bash
      changed_when: false
      tags: skip_in_development

    - name: Send test email as cloud
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          echo "Test email as cloud user from new/updated MSTMP at" `hostname` \
            | mail -s "Test SMTP `hostname`" cloud
        executable: /bin/bash
      changed_when: false
      tags: skip_in_development

  pre_tasks:
    - name: Ensure environment variables used below are set
      ansible.builtin.assert:
        that:
          - lookup('env', item) | length > 0
        fail_msg: "The environment variable '{{ item }}' is not set."
      loop:
        - HOST
        - PRODUCTION_SUBDOMAIN
        - STAGING_SUBDOMAIN
        - TELEMETRY_SUBDOMAIN
        - MONITOR_HTTP_PORT
        - LOGS_HTTP_PORT
        - METRICS_HTTP_PORT
        - TELEMETRY_GPRC_PORT
        - TELEMETRY_HTTP_PORT
        - EMAIL_ADDRESS
        - SMTP_HOST
        - SMTP_PORT
        - NETWORK_INTERFACE

    - name: Update package information
      become: true
      ansible.builtin.apt:
        update_cache: true
      changed_when: false

    - name: Install access control list utilities (needed to escalate privileges, see https://github.com/ansible/ansible/issues/16052)
      become: true
      ansible.builtin.package:
        name: acl
        state: present

  post_tasks:
    - name: Clean (Advanced Package Tool) APT cache and remove unused dependencies
      become: true
      ansible.builtin.apt:
        clean: true
        autoremove: true
        autoclean: true

  tasks:
    - name: Grant user `cloud` read-only access to journald
      ansible.builtin.user:
        name: cloud
        groups: systemd-journal
        append: true

    - name: Bash completion
      block:
        - name: Install Bash completion
          become: true
          ansible.builtin.package:
            name: bash-completion
            state: present

        # Inspired by https://stackoverflow.com/questions/40316836/update-bashrc-with-virtualenv-info-using-ansible/40317125#40317125
        # The comment also mentions an alternative better solution that uses a `~/.bashrc.d` directory.
        - name: Source Bash completion scripts in `~/.bashrc`
          ansible.builtin.blockinfile:
            dest: "{{ ansible_env.HOME | mandatory }}/.bashrc"
            block: |
              for file in /etc/bash_completion.d/* ; do
                  source "$file"
              done
            marker: "# {mark} ANSIBLE MANAGED BLOCK - bash-completion"
            insertbefore: BOF
            create: true
            mode: "0644"

    - name: Upgrades
      block:
        # Inspired by https://wiki.debian.org/UnattendedUpgrades
        # and https://askubuntu.com/questions/1305955/ansible-dpkg-reconfigure-plow-unattended-upgrades-stopped-while-running/1323117#1323117
        - name: Install `unattended-upgrades`
          become: true
          ansible.builtin.package:
            name: unattended-upgrades
            state: present

        - name: Install `apt-listchanges`
          become: true
          ansible.builtin.package:
            name: apt-listchanges
            state: present

        - name: Configure Debian to auto install security updates
          become: true
          ansible.builtin.debconf:
            name: unattended-upgrades
            question: unattended-upgrades/enable_auto_updates
            vtype: boolean
            value: "true"
        - name: Activate unattended upgrades
          become: true
          ansible.builtin.command:
            cmd: dpkg-reconfigure --force --frontend=noninteractive unattended-upgrades
            creates: /etc/apt/apt.conf.d/20auto-upgrades

    - name: Install GNU Make
      become: true
      ansible.builtin.package:
        name: make
        state: present

    - name: Hard disk management
      block:
        - name: Install Small Computer System Interface (SCSI) tools
        # Provides `rescan-scsi-bus.sh` used by `make scan`.
          become: true
          ansible.builtin.package:
            name: scsitools
            state: present

        # See https://opensource.com/article/18/11/partition-format-drive-linux
        - name: Install parted to partition hard disks
          become: true
          ansible.builtin.package:
            name: parted
            state: present

        - name: Install ext2/ext3/ext4 file system utilities to format hard disks
          become: true
          ansible.builtin.package:
            name: e2fsprogs
            state: present

    - name: Install Apache 2 utils to manage passwords for HTTP Basic Authentication using htpasswd
      become: true
      ansible.builtin.package:
        name: apache2-utils
        state: present

    - name: Install `moreutils` as it includes `chronic` that we use to cure Cron's chronic email problem
      # For details on the problem see https://habilis.net/cronic/
      become: true
      ansible.builtin.package:
        name: moreutils
        state: present

    - name: Install and configure `msmtp` to be used by Cron and other services to send emails
      vars:
        FROM_EMAIL_ADDRESS: 'server@{{ lookup("env", "HOST") }}'
        SMTP_HOST: '{{ lookup("env", "SMTP_HOST") }}'
        SMTP_PORT: '{{ lookup("env", "SMTP_PORT") }}'
      block:
        - name: Uninstall `mailutils` which includes GNU `mail`
          # The problem with GNU `mail` combined with `msmtp` is that aliases
          # in `/etc/aliases` are ignored. For example, when sending an email
          # by running `echo 'body' | mail -s 'subject' root`, the recipient
          # address is `root@hostname` instead of whatever email address is
          # given in `/etc/aliases` for `root`.
          become: true
          ansible.builtin.package:
            name: mailutils
            state: absent

        - name: Install `bsd-mailx` which provides the `mail` command
          # An alternative would be `s-nail`
          become: true
          ansible.builtin.package:
            name: bsd-mailx
            state: present

        - name: Install `msmtp` to send emails from mail user agents
          # For details see https://wiki.debian.org/msmtp
          # The manual is published under https://marlam.de/msmtp/msmtp.html
          # We do not use `sSMTP` because it is unmaintained according to https://wiki.debian.org/sSMTP
          become: true
          ansible.builtin.package:
            name: msmtp
            state: present

        - name: Install `msmtp-mta` to symbolically link `/usr/sbin/sendmail` to `msmtp` that other software can use to send mail
          become: true
          ansible.builtin.package:
            name: msmtp-mta
            state: present

        - name: Copy `mail.rc` configuration file
          become: true
          ansible.builtin.template:
            src: mail.rc.j2
            dest: /etc/mail.rc
            owner: root
            group: root
            mode: "0644"
          notify:
            - Send test email as root
            - Send test email as cloud

        - name: Copy system-wide `mstprc` configuration file
          become: true
          ansible.builtin.template:
            src: msmtprc.j2
            dest: /etc/msmtprc
            owner: root
            group: root
            mode: "0644"
          notify: Send test email as root

        - name: Copy user-specific `mstprc` configuration file
          ansible.builtin.template:
            src: msmtprc.j2
            dest: ~/.msmtprc
            mode: "0644"
          notify: Send test email as cloud

        - name: Copy `aliases` configuration file
          become: true
          vars:
            EMAIL_ADDRESS: '{{ lookup("env", "EMAIL_ADDRESS") }}'
          ansible.builtin.template:
            src: aliases.j2
            dest: /etc/aliases
            owner: root
            group: root
            mode: "0644"
          notify:
            - Send test email as root
            - Send test email as cloud

        - name: Flush handlers to send test emails
          ansible.builtin.meta: flush_handlers

    - name: Configure Cron
      block:
        - name: Add paths to environment variable `PATH` for root's crontab
          become: true
          community.general.cronvar:
            name: PATH
            value: /usr/local/bin/:/usr/bin:/bin
            state: present

        - name: Add paths to environment variable `PATH` for user's crontab
          community.general.cronvar:
            name: PATH
            value: /usr/local/bin/:/usr/bin:/bin
            state: present

        - name: Backup database and prune backups
          ansible.builtin.cron:
            name: database-backup
            special_time: daily
            job: "chronic make --directory=/app/machine --file=/app/machine/maintenance.mk backup prune-backups"

        - name: Renew Transport Layer Security (TLS) certificates needed for the `S` in `HTTPS`
          ansible.builtin.cron:
            name: tls-renewal
            special_time: daily
            job: "chronic make --directory=/app/machine --file=/app/machine/docker.mk renew-tls"

        - name: Set periodic docker system prune
          # See https://docs.docker.com/config/pruning/#prune-everything
          ansible.builtin.cron:
            name: docker-prune
            special_time: daily
            job: "chronic make --directory=/app/machine --file=/app/machine/maintenance.mk prune-docker"

        - name: Restart Docker backend service in production to reload rotated JWT certificates
          ansible.builtin.cron:
            name: restart-backend-service-in-production
            special_time: daily
            job: "chronic make --directory=/app/machine --file=/app/machine/maintenance.mk restart SERVICE=backend ENVIRONMENT=production"

        - name: Restart Docker backend service in staging to reload rotated JWT certificates
          ansible.builtin.cron:
            name: restart-backend-service-in-staging
            special_time: daily
            job: "chronic make --directory=/app/machine --file=/app/machine/maintenance.mk restart SERVICE=backend ENVIRONMENT=staging"

        - name: Rotate logs, vacuum `journald`, and clean-up backed up logs (as the root user)
          become: true
          ansible.builtin.cron:
            name: journald-vacuuming
            special_time: daily
            job: "chronic make --directory=/app/machine --file=/app/machine/logs.mk rotate vacuum clean-up"

    - name: GnuPG
      become: true
      block:
        - name: Add GnuPG dependencies
          ansible.builtin.package:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg2
              - lsb-release
            state: present

        - name: Add GnuPG key
          ansible.builtin.apt_key:
            url: https://repos.gnupg.org/deb/gnupg/bookworm/gnupg-signing-key.gpg
            id: 32097B719B3745D6E61DDA1B85C45AE3E1A2B355
            state: present

        - name: Add GnuPG repository
          ansible.builtin.apt_repository:
            repo: deb [arch=amd64] https://repos.gnupg.org/deb/gnupg/{{ ansible_distribution_release | mandatory }}/ {{ ansible_distribution_release | mandatory
              }} main
            state: present

        - name: Install GnuPG
          ansible.builtin.package:
            name: gnupg2
            state: present

    - name: Docker
      # Inspired by https://ops.tips/blog/docker-ansible-role/
      become: true
      block:
        - name: Add Docker dependencies
          ansible.builtin.package:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg2
              - lsb-release
            state: present

        - name: Add Docker key
          ansible.builtin.apt_key:
            url: https://download.docker.com/linux/debian/gpg
            id: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
            state: present

        - name: Docker Community Edition
          block:
            - name: Add Docker repository
              ansible.builtin.apt_repository:
                repo: deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release | mandatory }} stable
                state: present
            - name: Docker Engine, containerd, and Docker Compose
              ansible.builtin.package:
                name:
                  - docker-ce
                  - docker-ce-cli
                  - containerd.io
                  - docker-compose-plugin
                state: present

        - name: Prepare default daemon configuration
          # For a list of options see
          # https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file
          ansible.builtin.copy:
            src: ./docker-daemon.json
            dest: /etc/docker/daemon.json
            mode: "0644"
          notify:
            - Restart Docker

        - name: Add user `cloud` to group `docker`
          ansible.builtin.user:
            name: cloud
            groups: docker
            append: true

        - name: Enable Docker systemd service to start on boot
          ansible.builtin.service:
            name: docker
            enabled: true
            state: started

        - name: Flush handlers to restart Docker
          ansible.builtin.meta: flush_handlers

    - name: Vector
      # https://vector.dev/
      become: true
      block:
        - name: Add Vector key
          ansible.builtin.apt_key:
            url: https://keys.datadoghq.com/DATADOG_APT_KEY_CURRENT.public
            id: 5F1E256061D813B125E156E8E6266D4AC0962C7D
            state: present

        - name: Add Vector repository
          ansible.builtin.apt_repository:
            repo: deb [arch=amd64] https://apt.vector.dev stable vector-0
            state: present

        - name: Install Vector
          ansible.builtin.package:
            name: vector
            state: present

        - name: Configure Vector
          vars:
            LOGS_HTTP_PORT: '{{ lookup("env", "LOGS_HTTP_PORT") }}'
            METRICS_HTTP_PORT: '{{ lookup("env", "METRICS_HTTP_PORT") }}'
            TELEMETRY_GPRC_PORT: '{{ lookup("env", "TELEMETRY_GPRC_PORT") }}'
            TELEMETRY_HTTP_PORT: '{{ lookup("env", "TELEMETRY_HTTP_PORT") }}'
          ansible.builtin.template:
            src: vector.yaml.j2
            dest: /etc/vector/vector.yaml
            owner: root
            group: root
            mode: "0644"
          notify:
            - Reload Vector

        - name: Add user `vector` to group `docker`
          ansible.builtin.user:
            name: vector
            groups: docker
            append: true

        - name: Enable Vector systemd service to start on boot
          ansible.builtin.systemd:
            name: monit.service
            enabled: true
            state: started

        - name: Flush handlers to reload Vector
          ansible.builtin.meta: flush_handlers

    - name: Monitor system with Monit
      # https://mmonit.com/monit/
      become: true
      block:
        - name: Add Debian backports
          # https://backports.debian.org/
          ansible.builtin.apt_repository:
            repo: deb [arch=amd64] http://deb.debian.org/debian {{ ansible_distribution_release | mandatory }}-backports main
            state: present

        - name: Install Monit
          ansible.builtin.package:
            name: monit
            state: present

        - name: Configure Monit
          vars:
            HOST: '{{ lookup("env", "HOST") }}'
            PRODUCTION_HOST: '{{ lookup("env", "PRODUCTION_SUBDOMAIN") }}.{{ lookup("env", "HOST") }}'
            STAGING_HOST: '{{ lookup("env", "STAGING_SUBDOMAIN") }}.{{ lookup("env", "HOST") }}'
            TELEMETRY_HOST: '{{ lookup("env", "TELEMETRY_SUBDOMAIN") }}.{{ lookup("env", "HOST") }}'
            EMAIL_ADDRESS: '{{ lookup("env", "EMAIL_ADDRESS") }}'
            SMTP_HOST: '{{ lookup("env", "SMTP_HOST") }}'
            SMTP_PORT: '{{ lookup("env", "SMTP_PORT") }}'
            NETWORK_INTERFACE: '{{ lookup("env", "NETWORK_INTERFACE") }}'
            MONITOR_HTTP_PORT: '{{ lookup("env", "MONITOR_HTTP_PORT") }}'
            FROM_EMAIL_ADDRESS: 'monit@{{ lookup("env", "HOST") }}'
          ansible.builtin.template:
            src: monitrc.j2
            dest: /etc/monit/monitrc
            owner: root
            group: root
            mode: "0600"
          notify:
            - Reload Monit

        - name: Make Monit a systemd service
          ansible.builtin.copy:
            src: monit.service
            dest: /etc/systemd/system/monit.service
            owner: root
            group: root
            mode: "0644"

        - name: Enable Monit systemd service to start on boot
          ansible.builtin.systemd:
            name: monit.service
            enabled: true
            # reload daemon to make it notice the new monit.service file
            daemon_reload: true
            state: started

        - name: Grant user `cloud` read-only access to Monit without a password
          community.general.sudoers:
            name: monit-nopasswd
            user: username
            commands: /usr/bin/monit
            nopassword: yes
            state: present

        - name: Flush handlers to reload Monit
          ansible.builtin.meta: flush_handlers
