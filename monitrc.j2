# {{ ansible_managed }}
# /etc/monit/monitrc
# Inspired by https://mmonit.com/wiki/Monit/ConfigurationExamples

set daemon 60
    with start delay 60

set log /var/log/monit.log
set pidfile /var/run/monit.pid
set statefile /var/lib/monit/monit.state

# Configure email alerts
set mailserver {{ smtp_host }} port {{ smtp_port }}
set alert {{ email_address }}

# Test email alerts
# Inspired by https://serverfault.com/questions/328657/sending-a-test-example-alert-from-monit/328672#328672
# ```
# check file alerttest with path /.nonexistent
#     if does not exist then alert with reminder on 500 cycles
# ```
# Not necessary according to
# https://serverfault.com/questions/328657/sending-a-test-example-alert-from-monit/656190#656190

# [Global SSL Options](https://mmonit.com/monit/documentation/monit.html#SSL-OPTIONS)
set ssl options {
    verify: enable
    selfsigned: reject
}

# [Monit HTTPD](https://mmonit.com/monit/documentation/monit.html#MONIT-HTTPD)
set httpd
    port 2812
    use address 127.0.0.1
    unixsocket /var/run/monit.socket
    allow localhost
    allow monit:{{ monit_password }}

check system {{ non_www_host }}
    if loadavg (5min) > 3 then alert
    if loadavg (15min) > 1 then alert
    if memory usage > 80% for 4 cycles then alert
    if swap usage > 20% for 4 cycles then alert
    # Test the user part of CPU usage
    if cpu usage (user) > 80% for 3 cycles then alert
    # Test the system part of CPU usage
    if cpu usage (system) > 20% for 3 cycles then alert
    # Test the i/o wait part of CPU usage
    if cpu usage (wait) > 80% for 3 cycles then alert
    # Test CPU usage including user, system and wait. Note that multi-core
    # systems can generate 100% per core so total CPU usage can be more than
    # 100%
    if cpu usage > 80% for 4 cycles then alert

check filesystem data with path /app/data/
    if space usage > 95% then alert
    if service time > 300 milliseconds for 5 cycles then alert

check directory certificates with path /etc/ssl/certs/
    if changed timestamp then alert

check directory certbot with path /app/machine/certbot/
    if changed timestamp then alert

check directory secrets with path /app/production/secrets/
    if changed timestamp then alert

check file environment with path /app/production/.env
    if failed checksum then alert
    if changed timestamp then alert

# `make network-interfaces`
check network {{ network_interface }} with interface {{ network_interface }}
    if failed link then alert
    if changed link then alert
    if saturation > 80% then alert
    if total upload > 10 GB in last hour then alert

# [Check whether Docker is running](https://docs.docker.com/engine/daemon/troubleshoot/#check-whether-docker-is-running)
check program docker with path "/usr/bin/systemctl --quiet is-active docker"
    if status != 0 then alert

check program docker_healthcheck with path /app/machine/monit_docker_healthcheck.sh
    if status != 0 for 3 cycles then alert

check host {{ host }} with address {{ host }}
    if failed
        port 80
        with protocol http
        for 3 cycles
    then alert
    if failed
        port 443
        with protocol https
        and certificate valid > 7 days
        use ssl
        for 3 cycles
    then alert

check host {{ staging_host }} with address {{ staging_host }}
    if failed
        port 80
        with protocol http
        for 3 cycles
    then alert
    if failed
        port 443
        with protocol https
        and certificate valid > 7 days
        use ssl
        for 3 cycles
    then alert
